#loader{ :style => 'display: none;' }
  Loading, please wait....
  %img#loader{ :src => '/images/spinner.gif' }

#map
:javascript
  var map, infowin, youmarker, carmarkers = [], fsmarkers = [];

  function initMap() {
     var origin = new google.maps.LatLng(#{params[:lat]}, #{params[:lng]});

     map = new google.maps.Map(document.getElementById('map'), {
       zoom: 14,
       center: origin,
       gestureHandling: 'greedy',
       mapTypeControl: false,
       streetViewControl: false,
       zoomControl: true,
       zoomControlOptions: {
         position: google.maps.ControlPosition.TOP_LEFT
       }
     });

     var content = "Current Location:<br>#{@city.name}<p>"+
                   "<center><button onclick='getLocation()'>"+
                   "Update Location & Cars</button>"+
                   "<img id='spinner' src='/images/spinner.gif' "+
                   "style='display: none;'/></center>";

     infowin = new google.maps.InfoWindow({content: ""});

     youmarker = new google.maps.Marker({
       position: origin,
       map: map,
       title: "You",
       icon: '/images/marker_icon_me.png'
     });

     youmarker.addListener('click', function() {
       infowin.setContent(content);
       infowin.open(map, youmarker);
     });

     var directionsDisplay = new google.maps.DirectionsRenderer({
       suppressInfoWindows: true,
       suppressMarkers: true,
       preserveViewport: true,
       routeIndex: 0,
       map: map
     });
     var directionsService = new google.maps.DirectionsService();

     $('#loader').show();

     $.ajax({
       url: "/nearest?lat=#{params[:lat]}&lng=#{params[:lng]}&cid=#{@city.id}",
       method: 'get',
       dataType: 'json'
     }).done(function(data){
       $('#loader').hide();

       $.each(data.fs, function(idx, fs) {
         fsmarkers[idx] = new google.maps.Marker({
           position: fs.json_location,
           map: map,
           icon: fs.marker_icon,
           title: fs.name
         });

         fsmarkers[idx]._details = fs.details;
         fsmarkers[idx].addListener("click", function(){
           infowin.setContent(fsmarkers[idx]._details);
           infowin.open(map, fsmarkers[idx]);
         });
       });

       $.each(data.cars, function(idx, car) {
         carmarkers[idx] = new google.maps.Marker({
           position: car.json_location,
           map: map,
           title: car.name,
           icon: car.marker_icon
         });

         carmarkers[idx]._details = car.details;

         carmarkers[idx].addListener('click', function(){
           var request = {
             origin: youmarker.getPosition(),
             destination: carmarkers[idx].getPosition(),
             travelMode: 'WALKING'
           };

           directionsService.route(request, function(result, status) {
             if (status == 'OK') {
               var rt = result.routes[directionsDisplay.getRouteIndex()];
               directionsDisplay.setDirections(result);

               var totaltime = 0;
               $.each(rt.legs, function(idx, leg){
                 totaltime += leg.duration.value;
               });

               infowin.setContent(carmarkers[idx]._details +
                                  "<br>Walking time: " +
                                  Math.ceil(totaltime/60) + " mins");
               infowin.open(map, carmarkers[idx]);
             }
           });
         });
       })
     });
  }

%script{:async => "", :defer => "defer", :src => "/google.js"}

#demo

%form#location{ :method => "post", :action => "/cars" }
  %input#lat{ :type => "hidden", :name => "lat", :value => "0" }
  %input#lng{ :type => "hidden", :name => "lng", :value => "0" }

:javascript
  function getLocation() {
    $('#spinner').show();
    if (navigator.geolocation) {
       navigator.geolocation.getCurrentPosition(showPosition);
    } else {
       $('#demo').html("Geolocation is not supported by this browser.");
    }
  }

  function showPosition(position) {
    $('#spinner').hide();
    var lat = position.coords.latitude,
        lng = position.coords.longitude;

    var origin = new google.maps.LatLng(lat,lng);
    youmarker.setPosition(origin);
    map.setCenter(origin);
    infowin.close();
    $('#loader').show();

    $.ajax({
      url: "/city?lat=" + lat + "&lng=" + lng,
      method: 'get',
      dataType: 'json'
    }).done(function(data){
      $.ajax({
        url: "/nearest?lat="+lat+"&lng="+lng+"&cid="+data.cityid,
        method: 'get',
        dataType: 'json'
      }).done(function(data){
         $.each(data.fs, function(idx, fs) {
           fsmarkers[idx].setPosition(fs.json_location);
           fsmarkers[idx].setIcon(fs.marker_icon);
           fsmarkers[idx].setTitle(fs.name);
           fsmarkers[idx]._details = fs.details;
         });
         $.each(data.cars, function(idx, car) {
           carmarkers[idx].setPosition(car.json_location);
           carmarkers[idx].setIcon(car.marker_icon);
           carmarkers[idx].setTitle(car.name);
           carmarkers[idx]._details = car.details;
         });
         $('#loader').hide();
       });
    });
  }
